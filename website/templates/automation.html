{% extends "base.html" %}
{% block title %}Automation Logs{% endblock %}

{% block content %}
<h3 class="text-center mt-4">Automation Jobs</h3>
<hr>

<div class="row">
  {% for name, info in scripts.items() %}

  {# Health-badge: OK/WARN/FAIL #}
  {% set health = "OK" %}
  {% if info.critical_count > 0 %}
    {% set health = "FAIL" %}
  {% elif info.last_status in ["WARNING"] %}
    {% set health = "WARN" %}
  {% endif %}

  <div class="col-md-6 mb-4">
    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">{{ name }}</h5>
        {% if health == "OK" %}
          <span class="badge badge-success">OK</span>
        {% elif health == "WARN" %}
          <span class="badge badge-warning">WARN</span>
        {% else %}
          <span class="badge badge-danger">FAIL</span>
        {% endif %}
      </div>

      <div class="card-body">
        <p><strong>Last Run:</strong> {{ info.last_run.strftime("%Y-%m-%d %H:%M") }}</p>

        <p>
          <strong>Last Status:</strong>
          <span class="badge badge-info">{{ info.last_status }}</span>
        </p>

        <p><strong>Total Runs:</strong> {{ info.total_runs }}</p>

        {% if info.last_critical %}
          <p class="mb-2">
            <strong>Last CRITICAL:</strong>
            <span class="badge badge-danger">CRITICAL</span>
            <!-- knapp som öppnar modal för denna critical-log -->
            <a href="#" class="btn btn-sm btn-outline-danger ml-2"
               data-toggle="modal" data-target="#detailsModal{{ info.last_critical.id }}">
              View details
            </a>
          </p>
        {% endif %}

        <hr>

        <h6>Recent Logs</h6>
        <ul class="list-group">
          {% for log in info.recent %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <span class="badge badge-dark">{{ log.level }}</span>
              <span class="ml-2">{{ log.action }}</span>
              <br>
              <small class="text-muted">{{ log.time.strftime("%Y-%m-%d %H:%M") }}</small>
            </div>
            <a href="#" class="btn btn-sm btn-outline-secondary"
               data-toggle="modal" data-target="#detailsModal{{ log.id }}">
              Details
            </a>
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>

  {% endfor %}
</div>

{# --------------------- MODALS --------------------- #}
{% for name, info in scripts.items() %}
  {% for log in info.recent %}
  <div class="modal fade" id="detailsModal{{ log.id }}" tabindex="-1" role="dialog" aria-labelledby="detailsModalLabel{{ log.id }}" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title" id="detailsModalLabel{{ log.id }}">Log Details (ID {{ log.id }})</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <div class="modal-body">
          <p><strong>Level:</strong> {{ log.level }}</p>
          <p><strong>Action:</strong><br>{{ log.action }}</p>
          <p><strong>Time:</strong> {{ log.time.strftime("%Y-%m-%d %H:%M:%S") }}</p>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>

      </div>
    </div>
  </div>
  {% endfor %}
{% endfor %}

{% endblock %}
